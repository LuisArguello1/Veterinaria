{% load static %}

<!-- Verificar si el usuario ya tiene el máximo de mascotas -->
{% if maximo_mascotas >= 2 %}
<div class="registro-normal-content content-max-width">
    <div class="bg-red-50 border-l-4 border-red-400 p-4 rounded-lg">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-exclamation-triangle text-red-400 text-xl"></i>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-red-800">
                    Límite de mascotas alcanzado
                </h3>
                <div class="mt-2 text-sm text-red-700">
                    <p>Has alcanzado el límite máximo de <strong>2 mascotas</strong> por usuario.</p>
                    <p class="mt-1">Para registrar una nueva mascota, debes eliminar una de las existentes.</p>
                </div>
                <div class="mt-4">
                    <a href="{% url 'mascota:main_register' %}" class="bg-red-100 hover:bg-red-200 text-red-800 font-medium py-2 px-4 rounded-md transition-colors inline-flex items-center">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Volver a mis mascotas
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<!-- Contenido de Registro Normal - Diseño Integrado con IA -->
<div class="registro-normal-content content-max-width">
    <div class="bg-primary-50 p-5 rounded-lg">
        <div class="alert alert-info mb-4" role="alert">
            <div class="flex items-center">
                <i class="fas fa-robot mr-2 text-lg text-blue-600"></i>
                <div>
                    <strong>Registro Inteligente:</strong>
                    <p class="mt-1 text-sm">Sube una foto de tu mascota y nuestro sistema de IA predecirá automáticamente la raza y etapa de vida. ¡Tú decides si usar las predicciones!</p>
                </div>
            </div>
        </div>
        
        <form method="post" enctype="multipart/form-data" id="registro-form" class="space-y-6">
            {% csrf_token %}
            
            <!-- Sección de foto con predicciones -->
            <div class="bg-white p-4 rounded-lg shadow-sm border border-primary-100">
                <h3 class="text-md font-semibold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-camera text-primary-600 mr-2"></i>
                    Foto de Perfil
                    <span class="ml-2 text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Con IA</span>
                </h3>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <!-- Subida de imagen -->
                    <div class="lg:col-span-2">
                        <label for="{{ form.foto_perfil.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Selecciona una foto clara de tu mascota
                        </label>
                        <div class="mb-3 p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded-md text-sm text-yellow-800">
                            <div class="flex items-start">
                                <i class="fas fa-info-circle mr-3 text-yellow-600 mt-1"></i>
                                <div>
                                    <span class="block font-semibold text-yellow-800">Alcance del análisis con IA</span>
                                    <p class="mt-1">El servicio de análisis automático está optimizado para identificar con mayor fiabilidad estas tres razas: <strong>Chihuahua</strong>, <strong>Golden Retriever</strong> y <strong>Bulldog</strong>. Para cualquier otra raza, la predicción puede ser inexacta y debe considerarse únicamente como una sugerencia orientativa.</p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-1 flex justify-center px-4 pt-4 pb-4 border-2 border-gray-300 border-dashed rounded-md hover:border-primary-400 transition-colors" id="photo-upload-area">
                            <div class="space-y-1 text-center w-full">
                                <div id="photo-preview" class="hidden">
                                    <img id="preview-image" src="" alt="Vista previa" class="mx-auto h-32 w-32 object-cover rounded-lg shadow-md">
                                    <div class="mt-2">
                                        <button type="button" id="change-photo-btn" class="text-sm text-primary-600 hover:text-primary-800 underline">
                                            <i class="fas fa-sync-alt mr-1"></i>Cambiar imagen
                                        </button>
                                    </div>
                                </div>
                                <div id="upload-placeholder">
                                    <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-1"></i>
                                    <div class="flex text-sm text-gray-600 justify-center">
                                        <label for="{{ form.foto_perfil.id_for_label }}" class="relative cursor-pointer bg-white rounded-md font-medium text-primary-600 hover:text-primary-500">
                                            <span>Subir archivo</span>
                                        </label>
                                    </div>
                                    <p class="text-xs text-gray-500">PNG, JPG hasta 5MB</p>
                                </div>
                                <!-- Ocultar visualmente el input pero mantenerlo accesible -->
                                <div class="sr-only">
                                    {{ form.foto_perfil }}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Botón para predecir -->
                        <div class="mt-2">
                            <button type="button" id="predict-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded-md flex items-center justify-center text-sm disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <span id="predict-btn-text">Analizar con IA</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Panel de predicciones -->
                    <div id="predictions-panel" class="hidden">
                        <h4 class="font-semibold text-gray-800 mb-2 text-sm flex items-center">
                            <i class="fas fa-magic text-purple-600 mr-2"></i>
                            Predicciones
                        </h4>
                        
                        <!-- Predicción de raza -->
                        <div id="breed-prediction" class="mb-3 p-3 bg-orange-50 rounded-lg border border-orange-200 hidden">
                            <h5 class="font-medium text-orange-800 text-sm flex items-center">
                                <i class="fas fa-dog text-orange-600 mr-1"></i>Raza Detectada
                            </h5>
                            <div id="breed-result" class="text-sm text-orange-700 font-medium"></div>
                            <div id="breed-confidence" class="text-xs text-orange-600"></div>
                            <div id="breed-status" class="text-xs mt-1"></div>
                        </div>
                        
                        <!-- Predicción de etapa de vida -->
                        <div id="stage-prediction" class="mb-3 p-3 bg-green-50 rounded-lg border border-green-200 hidden">
                            <h5 class="font-medium text-green-800 text-sm flex items-center">
                                <i class="fas fa-calendar-alt text-green-600 mr-1"></i>Etapa Detectada
                            </h5>
                            <div id="stage-result" class="text-sm text-green-700 font-medium"></div>
                            <div id="stage-confidence" class="text-xs text-green-600"></div>
                            <div id="stage-status" class="text-xs mt-1"></div>
                        </div>
                        
                        <!-- Predicción de condición corporal -->
                        <div id="body-condition-prediction" class="mb-3 p-3 bg-blue-50 rounded-lg border border-blue-200 hidden">
                            <h5 class="font-medium text-blue-800 text-sm flex items-center">
                                <i class="fas fa-weight text-blue-600 mr-1"></i>Condición Corporal
                            </h5>
                            <div id="body-condition-result" class="text-sm text-blue-700 font-medium"></div>
                            <div id="body-condition-confidence" class="text-xs text-blue-600"></div>
                            <div id="body-condition-status" class="text-xs mt-1"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Información básica en grid compacto -->
            <div class="bg-white p-4 rounded-lg shadow-sm border border-primary-100">
                <h3 class="text-md font-semibold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-info-circle text-primary-600 mr-2"></i>
                    Información Básica
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div>
                        <label for="{{ form.nombre.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            Nombre *
                        </label>
                        {{ form.nombre }}
                    </div>
                    
                    <div>
                        <label for="{{ form.raza.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            Raza <span class="text-xs text-blue-600">(IA)</span>
                        </label>
                        {{ form.raza }}
                    </div>
                    
                    <div>
                        <label for="{{ form.etapa_vida.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            Etapa de Vida <span class="text-xs text-blue-600">(IA)</span>
                        </label>
                        {{ form.etapa_vida }}
                    </div>
                    
                    <div>
                        <label for="{{ form.sexo.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            Sexo
                        </label>
                        {{ form.sexo }}
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label for="{{ form.edad.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                                Edad
                            </label>
                            {{ form.edad }}
                        </div>
                        <div>
                            <label for="{{ form.edad_unidad.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                                Unidad
                            </label>
                            {{ form.edad_unidad }}
                        </div>
                    </div>
                    
                    <div>
                        <label for="{{ form.peso.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            Peso (kg)
                        </label>
                        {{ form.peso }}
                    </div>
                </div>
            </div>
            
            <!-- Información adicional -->
            <div class="bg-white p-4 rounded-lg shadow-sm border border-primary-100">
                <h3 class="text-md font-semibold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-notes-medical text-primary-600 mr-2"></i>
                    Información Adicional
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div>
                        <label for="{{ form.color.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            Color
                        </label>
                        {{ form.color }}
                    </div>
                    
                    <div>
                        <label for="{{ form.estado_corporal.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            Estado Corporal <span class="text-xs text-blue-600">(IA)</span>
                        </label>
                        {{ form.estado_corporal }}
                    </div>
                    
                    <div>
                        <label for="{{ form.fecha_nacimiento.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            Fecha de Nacimiento
                        </label>
                        {{ form.fecha_nacimiento }}
                    </div>
                    
                    <div class="md:col-span-3">
                        <label for="{{ form.caracteristicas_especiales.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            Características Especiales
                        </label>
                        {{ form.caracteristicas_especiales }}
                    </div>
                </div>
            </div>
            
            <!-- Botón de registro -->
            <div class="flex justify-end pt-2">
                <button type="submit" id="btn-registrar" class="bg-primary-600 hover:bg-primary-700 text-white py-2 px-4 rounded-md font-medium transition-colors flex items-center">
                    <i class="fas fa-save mr-2"></i>Registrar mascota
                </button>
            </div>
        </form>
    </div>
</div>

<!-- JavaScript simplificado para IA -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elementos DOM
    const fotoInput = document.getElementById('{{ form.foto_perfil.id_for_label }}');
    const predictBtn = document.getElementById('predict-btn');
    const predictBtnText = document.getElementById('predict-btn-text');
    const previewImage = document.getElementById('preview-image');
    const photoPreview = document.getElementById('photo-preview');
    const uploadPlaceholder = document.getElementById('upload-placeholder');
    const predictionsPanel = document.getElementById('predictions-panel');
    const changePhotoBtn = document.getElementById('change-photo-btn');
    const photoUploadArea = document.getElementById('photo-upload-area');
    
    // Variables de estado
    let currentPredictions = null;
    let fileSelected = false;
    
    // Inicializar estado
    resetPhotoUpload();
    
    // Manejar cambio de archivo
    fotoInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // Procesar y mostrar la imagen seleccionada
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImage.src = e.target.result;
                photoPreview.classList.remove('hidden');
                uploadPlaceholder.classList.add('hidden');
                predictBtn.disabled = false;
                fileSelected = true;
                
                // Limpiar predicciones anteriores
                predictionsPanel.classList.add('hidden');
                
                // Reiniciar paneles de predicción
                document.getElementById('breed-prediction').classList.add('hidden');
                document.getElementById('stage-prediction').classList.add('hidden');
                document.getElementById('body-condition-prediction').classList.add('hidden');
            };
            reader.readAsDataURL(file);
        } else {
            resetPhotoUpload();
        }
    });
    
    // Manejar clic en el área de subida solo cuando el placeholder está visible
    photoUploadArea.addEventListener('click', function(e) {
        // Solo activar el input de archivo si se muestra el placeholder y no hay imagen previa
        if (!photoPreview.classList.contains('hidden')) {
            return; // Ya hay una imagen, no hacer nada al hacer clic en el área
        }
        
        // Solo activar si el clic no fue en el botón de cambiar
        if (e.target !== changePhotoBtn && !changePhotoBtn.contains(e.target)) {
            fotoInput.click();
        }
    });
    
    // Manejar botón de cambiar imagen
    if (changePhotoBtn) {
        changePhotoBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            fotoInput.click();
        });
    }
    
    function resetPhotoUpload() {
        // Restablecer elementos visuales
        photoPreview.classList.add('hidden');
        uploadPlaceholder.classList.remove('hidden');
        predictBtn.disabled = true;
        predictionsPanel.classList.add('hidden');
        
        // Restablecer estado interno
        fileSelected = false;
        currentPredictions = null;
        
        // Limpiar el input de archivo sin activarlo
        try {
            fotoInput.value = '';
        } catch (e) {
            // En algunos navegadores, esto puede fallar por razones de seguridad
            console.warn("No se pudo resetear input de archivo:", e);
        }
        
        // Ocultar todos los paneles de predicción
        document.getElementById('breed-prediction').classList.add('hidden');
        document.getElementById('stage-prediction').classList.add('hidden');
        document.getElementById('body-condition-prediction').classList.add('hidden');
    }
    
    // Manejar predicción
    predictBtn.addEventListener('click', function() {
        const file = fotoInput.files[0];
        if (!file) return;
        
        predictBtn.disabled = true;
        predictBtnText.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Analizando...';
        
        const formData = new FormData();
        formData.append('image', file);
        
        fetch('{% url "mascota:predict_image_ajax" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentPredictions = data.predictions;
                showPredictions(data.predictions);
            } else {
                alert('Error en predicción: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error en la conexión');
        })
        .finally(() => {
            predictBtn.disabled = false;
            predictBtnText.innerHTML = '<i class="fas fa-brain mr-2"></i>Analizar con IA';
        });
    });
    
    function showPredictions(predictions) {
        predictionsPanel.classList.remove('hidden');
        
        // Mostrar predicción de raza
        if (predictions.breed) {
            const breedPanel = document.getElementById('breed-prediction');
            const breedResult = document.getElementById('breed-result');
            const breedConfidence = document.getElementById('breed-confidence');
            const breedStatus = document.getElementById('breed-status');
            
            const confidence = predictions.breed.confidence_percentage;
            
            // Siempre mostrar la predicción, independientemente de la confianza
            breedResult.textContent = predictions.breed.display_name;
            breedConfidence.textContent = `Confianza: ${confidence}%`;
            
            if (confidence >= 70) {
                // Confianza alta: indicar que es confiable
                breedStatus.innerHTML = '<i class="fas fa-check-circle text-green-500 mr-1"></i>Predicción confiable';
                breedPanel.className = 'mb-3 p-3 bg-green-50 rounded-lg border border-green-200';
            } else {
                // Confianza baja: advertir pero mostrar la predicción
                breedStatus.innerHTML = '<i class="fas fa-exclamation-triangle text-yellow-500 mr-1"></i>Predicción con baja confianza';
                breedPanel.className = 'mb-3 p-3 bg-yellow-50 rounded-lg border border-yellow-200';
            }
            
            breedPanel.classList.remove('hidden');
        }
        
        // Mostrar predicción de etapa
        if (predictions.stage) {
            const stagePanel = document.getElementById('stage-prediction');
            const stageResult = document.getElementById('stage-result');
            const stageConfidence = document.getElementById('stage-confidence');
            const stageStatus = document.getElementById('stage-status');
            
            const confidence = predictions.stage.confidence_percentage;
            
            // Siempre mostrar la predicción, independientemente de la confianza
            stageResult.textContent = predictions.stage.display_name;
            stageConfidence.textContent = `Confianza: ${confidence}%`;
            
            if (confidence >= 70) {
                // Confianza alta: indicar que es confiable
                stageStatus.innerHTML = '<i class="fas fa-check-circle text-green-500 mr-1"></i>Predicción confiable';
                stagePanel.className = 'mb-3 p-3 bg-green-50 rounded-lg border border-green-200';
            } else {
                // Confianza baja: advertir pero mostrar la predicción
                stageStatus.innerHTML = '<i class="fas fa-exclamation-triangle text-yellow-500 mr-1"></i>Predicción con baja confianza';
                stagePanel.className = 'mb-3 p-3 bg-yellow-50 rounded-lg border border-yellow-200';
            }
            
            stagePanel.classList.remove('hidden');
        }
        
        // Mostrar predicción de condición corporal
        if (predictions.body_condition) {
            const bodyConditionPanel = document.getElementById('body-condition-prediction');
            const bodyConditionResult = document.getElementById('body-condition-result');
            const bodyConditionConfidence = document.getElementById('body-condition-confidence');
            const bodyConditionStatus = document.getElementById('body-condition-status');
            
            const confidence = predictions.body_condition.confidence_percentage;
            
            // Siempre mostrar la predicción, independientemente de la confianza
            bodyConditionResult.textContent = predictions.body_condition.display_name;
            bodyConditionConfidence.textContent = `Confianza: ${confidence}%`;
            
            // Cambiar color según la condición
            if (predictions.body_condition.predicted === 'normal') {
                bodyConditionPanel.className = 'mb-3 p-3 bg-green-50 rounded-lg border border-green-200';
            } else if (predictions.body_condition.predicted === 'delgado') {
                bodyConditionPanel.className = 'mb-3 p-3 bg-yellow-50 rounded-lg border border-yellow-200';
            } else { // obeso
                bodyConditionPanel.className = 'mb-3 p-3 bg-red-50 rounded-lg border border-red-200';
            }
            
            if (confidence >= 70) {
                // Confianza alta: indicar que es confiable
                bodyConditionStatus.innerHTML = '<i class="fas fa-check-circle text-green-500 mr-1"></i>Predicción confiable';
            } else {
                // Confianza baja: advertir pero mostrar la predicción
                bodyConditionStatus.innerHTML = '<i class="fas fa-exclamation-triangle text-yellow-500 mr-1"></i>Predicción con baja confianza';
            }
            
            bodyConditionPanel.classList.remove('hidden');
        }
    }
});
</script>

{% endif %}