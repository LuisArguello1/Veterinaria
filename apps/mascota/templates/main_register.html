{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}Mi Mascota{% endblock %}

{% block content %}
<div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    <!-- Cabecera profesional y minimalista -->
    <div class="bg-white mb-6 shadow-sm border border-gray-200 rounded-lg overflow-hidden">
        <div class="flex flex-col sm:flex-row items-center p-4 sm:p-0">
            <div class="mr-0 sm:mr-6 bg-black p-2 mb-4 sm:mb-0 self-center sm:self-start">
                <img src="{% static 'img/logo_secundario2.png' %}" alt="Logo Secundario Veterinaria" class="h-16 sm:h-20 w-auto" oncontextmenu="return false;">
            </div>
            <div class="text-center sm:text-left py-2 sm:py-4">
                <h1 class="text-gray-800 text-xl sm:text-2xl font-semibold mb-1">Registro de Mascotas</h1>
                <p class="text-gray-600 text-sm sm:text-base">Información completa para el cuidado óptimo</p>
            </div>
        </div>
    </div>

    <!-- Tabs para cambiar entre registro normal y datos biométricos -->
    <div class="bg-white rounded-lg shadow mb-6">
        <div class="border-b border-gray-200 overflow-x-auto">
            <div class="flex px-4 sm:px-6 pt-4 pb-0 min-w-max">
                <button type="button" class="tab-btn active py-3 px-3 border-b-2 border-primary-500 font-medium text-primary-600 flex items-center mr-3 sm:mr-6" data-target="mi-mascota">
                    <i class="fas fa-paw mr-1 sm:mr-2"></i>
                    <span class="text-sm sm:text-base">Mi Mascota</span>
                </button>
                <button type="button" class="tab-btn py-3 px-3 border-b-2 border-transparent font-medium {% if total_mascotas_usuario >= 2 %}text-gray-400 cursor-not-allowed{% else %}text-gray-500 hover:text-gray-700 hover:border-gray-300{% endif %} flex items-center mr-3 sm:mr-6" data-target="registro-normal" {% if total_mascotas_usuario >= 2 %}disabled title="Límite máximo de 2 mascotas alcanzado"{% endif %}>
                    <i class="fas fa-clipboard-list mr-1 sm:mr-2"></i>
                    <span class="text-sm sm:text-base">Registro Normal</span>
                    {% if total_mascotas_usuario >= 2 %}
                        <i class="fas fa-lock ml-1 text-xs"></i>
                    {% endif %}
                </button>
                <button type="button" class="tab-btn py-3 px-3 border-b-2 border-transparent font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 flex items-center" data-target="datos-biometricos">
                    <i class="fas fa-fingerprint mr-1 sm:mr-2"></i>
                    <span class="text-sm sm:text-base">Datos Biométricos</span>
                </button>
            </div>
        </div>

    <!-- Contenido de las pestañas -->
    <div class="tab-content-container p-3 sm:p-6">
        <!-- Pestaña 1: Mi Mascota -->
        <div id="mi-mascota" class="tab-content" style="display: block;">
            <div class="p-4 sm:p-6 bg-white border border-primary-100 rounded-lg shadow-sm hidden" id="mi-mascota-content">
                <div class="mb-4 flex flex-wrap items-center">
                    <div class="h-10 w-10 rounded-full bg-primary-100 flex items-center justify-center mr-3">
                        <i class="fas fa-paw text-primary-600"></i>
                    </div>
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-800">Detalles de su Mascota</h2>
                </div>
                
                <!-- Contenido de mascotas del usuario -->
                {% if mascota_count > 0 %}
                <div class="mx-auto max-w-7xl">
                    <!-- Selector de mascotas si hay más de una -->
                    {% if mascota_count > 1 %}
                    <div class="mb-6 flex justify-center">
                        <div class="inline-flex rounded-md shadow-sm" role="group">
                            {% for data in mascota_data %}
                            <button type="button" class="mascota-tab-btn {% if forloop.first %}active{% endif %} px-4 py-2 text-sm font-medium {% if forloop.first %}bg-primary-700 text-white{% else %}bg-white text-gray-700 hover:bg-gray-100{% endif %} {% if forloop.first %}rounded-l-lg border border-primary-700{% elif forloop.last %}rounded-r-lg border border-gray-200{% else %}border-t border-b border-gray-200{% endif %}" data-target="mascota-{{ data.mascota.id }}">
                                {{ data.mascota.nombre }}
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    <!-- Contenedor para cada mascota -->
                    {% for data in mascota_data %}
                    <div class="mascota-detail {% if not forloop.first %}hidden{% endif %}" id="mascota-{{ data.mascota.id }}">
                        <!-- Cabecera con información principal -->
                        <div class="mb-6 bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                            <div class="flex flex-col md:flex-row">
                                <!-- Imagen principal o placeholder -->
                                <div class="w-full md:w-1/3 bg-primary-50 flex items-center justify-center p-6">
                                    {% if data.mascota.foto_perfil %}
                                        <img src="{{ data.mascota.foto_perfil.url }}" alt="{{ data.mascota.nombre }}" class="rounded-lg max-h-48 object-cover shadow-md">
                                    {% else %}
                                        <div class="w-full h-48 bg-gray-100 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-paw text-gray-400 text-6xl"></i>
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Información principal -->
                                <div class="w-full md:w-2/3 p-6">
                                    <div class="flex items-center mb-3">
                                        <h1 class="text-2xl font-bold text-gray-800">{{ data.mascota.nombre }}</h1>
                                        {% if data.biometria_entrenada %}
                                            <span class="ml-3 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                <i class="fas fa-fingerprint mr-1"></i> Biometría Activa
                                            </span>
                                        {% endif %}
                                    </div>
                                
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div>
                                            <p class="text-sm text-gray-600 mb-2">
                                                <span class="font-medium text-gray-700">Especie/Raza:</span> 
                                                {{ data.mascota.raza|default:"No especificada" }}
                                            </p>
                                            <p class="text-sm text-gray-600 mb-2">
                                                <span class="font-medium text-gray-700">Edad:</span> 
                                                {{ data.mascota.edad_completa }}
                                            </p>
                                            <p class="text-sm text-gray-600 mb-2">
                                                <span class="font-medium text-gray-700">Sexo:</span> 
                                                {{ data.mascota.get_sexo_display|default:"No especificado" }}
                                            </p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-600 mb-2">
                                                <span class="font-medium text-gray-700">Etapa de vida:</span> 
                                                {{ data.mascota.get_etapa_vida_display|default:"No especificada" }}
                                            </p>
                                            <p class="text-sm text-gray-600 mb-2">
                                                <span class="font-medium text-gray-700">Estado corporal:</span> 
                                                {{ data.mascota.get_estado_corporal_display|default:"No especificado" }}
                                            </p>
                                            <p class="text-sm text-gray-600 mb-2">
                                                <span class="font-medium text-gray-700">Peso:</span> 
                                                {% if data.mascota.peso %}{{ data.mascota.peso }} kg{% else %}No especificado{% endif %}
                                            </p>
                                        </div>
                                    </div>
                                
                                    <!-- Botones de acción -->
                                    <div class="mt-4 grid grid-cols-2 sm:grid-cols-5 gap-2">
                                        <button onclick="editarMascota({{ data.mascota.id }})" class="inline-flex items-center justify-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50">
                                            <i class="fas fa-edit mr-1"></i> Editar información
                                        </button>
                                        <button onclick="generarQR({{ data.mascota.id }})" 
                                            class="inline-flex items-center justify-center px-3 py-2 border border-blue-300 text-sm font-medium rounded-md shadow-sm text-blue-600 bg-white hover:bg-blue-50 hover:border-blue-400">
                                            <i class="fas fa-qrcode mr-1"></i> Código QR
                                        </button>
                                        
                                        <!-- Botón de reportar perdida / cancelar perdida -->
                                        {% if dat.mascota.biometria_entrenada %}
                                            {% if data.mascota.reportar_perdida %}
                                            <button onclick="cancelarReportePerdida({{ data.mascota.id }}, '{{ data.mascota.nombre }}')" 
                                                class="inline-flex items-center justify-center px-3 py-2 border border-green-300 text-sm font-medium rounded-md shadow-sm text-green-600 bg-white hover:bg-green-50 hover:border-green-400">
                                                <i class="fas fa-check-circle mr-1"></i> Cancelar perdida
                                            </button>
                                            {% else %}
                                            <button onclick="reportarMascotaPerdida({{ data.mascota.id }}, '{{ data.mascota.nombre }}')" 
                                                class="inline-flex items-center justify-center px-3 py-2 border border-orange-300 text-sm font-medium rounded-md shadow-sm text-orange-600 bg-white hover:bg-orange-50 hover:border-orange-400">
                                                <i class="fas fa-exclamation-triangle mr-1"></i> Reportar perdida
                                            </button>
                                            {% endif %}
                                        {% endif %}
                                        
                                        {% if data.biometria_entrenada %}
                                        <button onclick="eliminarBiometria({{ data.mascota.id }}, '{{ data.mascota.nombre }}')" 
                                            class="inline-flex items-center justify-center px-3 py-2 border border-orange-300 text-sm font-medium rounded-md shadow-sm text-orange-600 bg-white hover:bg-orange-50 hover:border-orange-400">
                                            <i class="fas fa-eye-slash mr-1"></i> Eliminar biometría
                                        </button>
                                        {% endif %}
                                        <button onclick="eliminarMascota({{ data.mascota.id }}, '{{ data.mascota.nombre }}')" 
                                            class="inline-flex items-center justify-center px-3 py-2 border border-red-300 text-sm font-medium rounded-md shadow-sm text-red-600 bg-white hover:bg-red-50 hover:border-red-400">
                                            <i class="fas fa-trash mr-1"></i> Eliminar Mascota
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Panel principal: Información detallada -->
                            <div class="lg:col-span-2">
                                <!-- Detalles adicionales -->
                                <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6 overflow-hidden">
                                    <div class="border-b border-gray-200 bg-gray-50 px-4 py-3 sm:px-6">
                                        <h3 class="text-lg font-medium leading-6 text-gray-900 flex items-center">
                                            <i class="fas fa-info-circle text-primary-500 mr-2"></i> Información detallada
                                        </h3>
                                    </div>
                                    <div class="px-4 py-5 sm:p-6">
                                        <dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-6">
                                            {% if data.mascota.fecha_nacimiento %}
                                            <div>
                                                <dt class="text-sm font-medium text-gray-500">Fecha de nacimiento</dt>
                                                <dd class="mt-1 text-sm text-gray-900">{{ data.mascota.fecha_nacimiento|date:"d/m/Y" }}</dd>
                                            </div>
                                            {% endif %}
                                            
                                            {% if data.mascota.color %}
                                            <div>
                                                <dt class="text-sm font-medium text-gray-500">Color</dt>
                                                <dd class="mt-1 text-sm text-gray-900">{{ data.mascota.color }}</dd>
                                            </div>
                                            {% endif %}
                                            
                                            <div>
                                                <dt class="text-sm font-medium text-gray-500">Fecha de registro</dt>
                                                <dd class="mt-1 text-sm text-gray-900">{{ data.mascota.created_at|date:"d/m/Y H:i" }}</dd>
                                            </div>
                                            
                                            <div>
                                                <dt class="text-sm font-medium text-gray-500">Última actualización</dt>
                                                <dd class="mt-1 text-sm text-gray-900">{{ data.mascota.updated_at|date:"d/m/Y H:i" }}</dd>
                                            </div>
                                            
                                            {% if data.mascota.caracteristicas_especiales %}
                                            <div class="sm:col-span-2">
                                                <dt class="text-sm font-medium text-gray-500">Características especiales</dt>
                                                <dd class="mt-1 text-sm text-gray-900 whitespace-pre-line">{{ data.mascota.caracteristicas_especiales }}</dd>
                                            </div>
                                            {% endif %}
                                        </dl>
                                    </div>
                                </div>
                                
                                <!-- Recomendaciones de cuidado personalizadas -->
                                <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6 overflow-hidden">
                                    <div class="border-b border-gray-200 bg-gradient-to-r from-green-50 to-blue-50 px-4 py-3 sm:px-6">
                                        <h3 class="text-lg font-medium leading-6 text-gray-900 flex items-center">
                                            <i class="fas fa-heart text-green-500 mr-2"></i> Recomendaciones de Cuidado
                                            <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                Personalizado
                                            </span>
                                        </h3>
                                        <p class="text-sm text-gray-600 mt-1">Cuidados específicos basados en las características de {{ data.mascota.nombre }}</p>
                                    </div>
                                    <div class="px-4 py-5 sm:p-6">
                                        {% with recomendaciones=data.mascota.get_recomendaciones_cuidado %}
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <!-- Alimentación -->
                                            {% if recomendaciones.alimentacion %}
                                            <div class="bg-orange-50 rounded-lg p-4 border border-orange-100">
                                                <h4 class="font-semibold text-orange-800 mb-3 flex items-center">
                                                    <i class="fas fa-utensils text-orange-600 mr-2"></i> Alimentación
                                                </h4>
                                                <ul class="space-y-2">
                                                    {% for recom in recomendaciones.alimentacion %}
                                                    <li class="text-sm text-orange-700 flex items-start">
                                                        <i class="fas fa-check-circle text-orange-500 mr-2 mt-0.5 flex-shrink-0"></i>
                                                        <span>{{ recom }}</span>
                                                    </li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                            {% endif %}
                                            
                                            <!-- Ejercicio -->
                                            {% if recomendaciones.ejercicio %}
                                            <div class="bg-blue-50 rounded-lg p-4 border border-blue-100">
                                                <h4 class="font-semibold text-blue-800 mb-3 flex items-center">
                                                    <i class="fas fa-running text-blue-600 mr-2"></i> Ejercicio
                                                </h4>
                                                <ul class="space-y-2">
                                                    {% for recom in recomendaciones.ejercicio %}
                                                    <li class="text-sm text-blue-700 flex items-start">
                                                        <i class="fas fa-check-circle text-blue-500 mr-2 mt-0.5 flex-shrink-0"></i>
                                                        <span>{{ recom }}</span>
                                                    </li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                            {% endif %}
                                            
                                            <!-- Salud -->
                                            {% if recomendaciones.salud %}
                                            <div class="bg-red-50 rounded-lg p-4 border border-red-100">
                                                <h4 class="font-semibold text-red-800 mb-3 flex items-center">
                                                    <i class="fas fa-heartbeat text-red-600 mr-2"></i> Salud
                                                </h4>
                                                <ul class="space-y-2">
                                                    {% for recom in recomendaciones.salud %}
                                                    <li class="text-sm text-red-700 flex items-start">
                                                        <i class="fas fa-check-circle text-red-500 mr-2 mt-0.5 flex-shrink-0"></i>
                                                        <span>{{ recom }}</span>
                                                    </li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                            {% endif %}
                                            
                                            <!-- Cuidado General -->
                                            {% if recomendaciones.cuidado_general %}
                                            <div class="bg-purple-50 rounded-lg p-4 border border-purple-100">
                                                <h4 class="font-semibold text-purple-800 mb-3 flex items-center">
                                                    <i class="fas fa-spa text-purple-600 mr-2"></i> Cuidado General
                                                </h4>
                                                <ul class="space-y-2">
                                                    {% for recom in recomendaciones.cuidado_general %}
                                                    <li class="text-sm text-purple-700 flex items-start">
                                                        <i class="fas fa-check-circle text-purple-500 mr-2 mt-0.5 flex-shrink-0"></i>
                                                        <span>{{ recom }}</span>
                                                    </li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Nota informativa -->
                                        <div class="mt-6 bg-gray-50 rounded-lg p-4 border border-gray-200">
                                            <div class="flex items-start">
                                                <i class="fas fa-info-circle text-gray-400 mr-3 mt-0.5"></i>
                                                <div>
                                                    <p class="text-sm text-gray-600">
                                                        <strong>Nota importante:</strong> Estas recomendaciones son generales basadas en las características de {{ data.mascota.nombre }}. 
                                                        Siempre consulte con un veterinario para obtener consejos específicos sobre la salud y cuidado de su mascota.
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                        {% endwith %}
                                    </div>
                                </div>
                                
                                <!-- Galería de imágenes -->
                                <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                                    <div class="border-b border-gray-200 bg-gray-50 px-4 py-3 sm:px-6 flex justify-between items-center">
                                        <h3 class="text-lg font-medium leading-6 text-gray-900 flex items-center">
                                            <i class="fas fa-images text-primary-500 mr-2"></i> Galería de imágenes
                                        </h3>
                                        <span class="text-sm text-gray-600">{{ data.total_images|default:"0" }} imágenes</span>
                                    </div>
                                    <div class="px-4 py-5 sm:p-6">
                                        {% if data.images_by_type %}
                                            {% for type_name, images in data.images_by_type.items %}
                                            <h4 class="text-md font-medium text-gray-700 mb-2 flex items-center">
                                                <i class="fas fa-tag text-primary-400 mr-2"></i> {{ type_name }} ({{ images|length }})
                                            </h4>
                                            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 mb-4">
                                                {% for img in images %}
                                                    <div class="group relative aspect-square overflow-hidden rounded-md border border-gray-200">
                                                        <img src="{{ img.imagen.url }}" alt="Imagen {{ img.id }}" 
                                                            class="h-full w-full object-cover transition-transform group-hover:scale-110 duration-300">
                                                        <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-xs p-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                            {{ img.uploaded_at|date:"d/m/Y" }}
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        {% endfor %}
                                        {% else %}
                                            <div class="text-center py-6">
                                                <div class="mx-auto h-12 w-12 text-gray-300">
                                                    <i class="fas fa-image text-4xl"></i>
                                                </div>
                                                <h3 class="mt-2 text-sm font-medium text-gray-900">No hay imágenes</h3>
                                                <p class="mt-1 text-sm text-gray-500">Añade imágenes para tu mascota.</p>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Panel lateral: Estado biométrico y reconocimientos -->
                            <div class="lg:col-span-1">
                                <!-- Estado del entrenamiento biométrico -->
                                <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                                    <div class="border-b border-gray-200 bg-gray-50 px-4 py-3 sm:px-6">
                                        <h3 class="text-lg font-medium leading-6 text-gray-900 flex items-center">
                                            <i class="fas fa-fingerprint text-primary-500 mr-2"></i> Estado biométrico
                                        </h3>
                                    </div>
                                    <div class="px-4 py-5 sm:p-6">
                                        <div class="mb-4">
                                            <h4 class="text-sm font-medium text-gray-700 mb-1">Imágenes biométricas</h4>
                                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                                <div class="bg-primary-600 h-2.5 rounded-full" style="width: {% widthratio data.biometric_images|default:0 20 100 %}%"></div>
                                            </div>
                                            <div class="flex justify-between text-xs mt-1">
                                                <span>{{ data.biometric_images|default:0 }}/20</span>
                                                <span>{% widthratio data.biometric_images|default:0 20 100 %}%</span>
                                            </div>
                                        </div>
                                    
                                        <div class="my-4">
                                            <h4 class="text-sm font-medium text-gray-700 mb-1">Estado</h4>
                                            {% if data.biometria_entrenada %}
                                                <div class="rounded-md bg-green-50 p-3">
                                                    <div class="flex">
                                                        <div class="flex-shrink-0">
                                                            <i class="fas fa-check-circle text-green-400"></i>
                                                        </div>
                                                        <div class="ml-3">
                                                            <h3 class="text-sm font-medium text-green-800">Reconocimiento completado</h3>
                                                            <div class="mt-2 text-sm text-green-700">
                                                                <p>La biometría de esta mascota está activa y lista para ser reconocida.</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% elif data.tiene_suficientes_imagenes %}
                                                <div class="rounded-md bg-yellow-50 p-3">
                                                    <div class="flex">
                                                        <div class="flex-shrink-0">
                                                            <i class="fas fa-exclamation-circle text-yellow-400"></i>
                                                        </div>
                                                        <div class="ml-3">
                                                            <h3 class="text-sm font-medium text-yellow-800">Listo para activar</h3>
                                                            <div class="mt-2 text-sm text-yellow-700">
                                                                <p>Has subido suficientes imágenes. Puedes activar el reconocimiento facial ahora.</p>
                                                                <div class="mt-3">
                                                                    <button type="button" onclick="entrenarModelo({{ data.mascota.id }})" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md shadow-sm text-white bg-yellow-600 hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500">
                                                                        <i class="fas fa-brain mr-1"></i> Activar Reconocimiento
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% else %}
                                            <div class="rounded-md bg-blue-50 p-3">
                                                <div class="flex">
                                                    <div class="flex-shrink-0">
                                                        <i class="fas fa-info-circle text-blue-400"></i>
                                                    </div>
                                                    <div class="ml-3">
                                                        <h3 class="text-sm font-medium text-blue-800">Requiere más imágenes</h3>
                                                        <div class="mt-2 text-sm text-blue-700">
                                                            <p>Necesitas subir más imágenes para completar el reconocimiento facial.</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Historial de reconocimientos -->
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                                <div class="border-b border-gray-200 bg-gray-50 px-4 py-3 sm:px-6">
                                    <h3 class="text-lg font-medium leading-6 text-gray-900 flex items-center">
                                        <i class="fas fa-history text-primary-500 mr-2"></i> Últimos reconocimientos
                                    </h3>
                                </div>
                                <div class="px-4 py-5 sm:p-6">
                                    {% if data.reconocimientos %}
                                        <div class="space-y-3">
                                            {% for rec in data.reconocimientos %}
                                            <div class="flex items-start space-x-3 pb-3 {% if not forloop.last %}border-b border-gray-200{% endif %}">
                                                <div class="flex-shrink-0 h-10 w-10 overflow-hidden rounded-md bg-gray-200">
                                                    {% if rec.imagen_analizada %}
                                                    <img src="{{ rec.imagen_analizada.url }}" alt="Reconocimiento" class="h-full w-full object-cover">
                                                    {% else %}
                                                    <div class="h-full w-full flex items-center justify-center">
                                                        <i class="fas fa-image text-gray-400"></i>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                                <div class="flex-1 min-w-0">
                                                    <p class="text-sm font-medium text-gray-900">
                                                        {% if rec.exito %}
                                                        <span class="text-green-600">Reconocimiento exitoso</span>
                                                        {% else %}
                                                        <span class="text-yellow-600">No identificado</span>
                                                        {% endif %}
                                                    </p>
                                                    <p class="text-xs text-gray-500">
                                                        {{ rec.fecha|date:"d/m/Y H:i" }} · 
                                                        <span class="{% if rec.exito %}text-green-600{% else %}text-yellow-600{% endif %}">
                                                            Confianza: {{ rec.confianza|floatformat:2 }}
                                                        </span>
                                                    </p>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <div class="text-center py-4">
                                            <p class="text-sm text-gray-500">No hay reconocimientos registrados para esta mascota.</p>
                                        </div>
                                    {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <!-- Mensaje cuando no hay mascotas -->
                <div class="text-center py-10">
                    <div class="mx-auto h-20 w-20 text-gray-300 mb-4">
                        <i class="fas fa-paw text-5xl"></i>
                    </div>
                    <h3 class="mt-2 text-lg font-medium text-gray-900">No tiene mascotas registradas</h3>
                    <p class="mt-1 text-gray-500">Use la pestaña "Registro Normal" para añadir una nueva mascota.</p>
                    <div class="mt-6">
                        <button type="button" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500" onclick="document.querySelector('.tab-btn[data-target=\'registro-normal\']').click()">
                            <i class="fas fa-plus-circle mr-2"></i>
                            Registrar nueva mascota
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Pestaña 2: Registro normal -->
        <div id="registro-normal" class="tab-content" style="display: none;">
            <div class="p-4 sm:p-6 bg-white border border-primary-100 rounded-lg shadow-sm" id="registro-normal-content">
                <div class="mb-4 flex flex-wrap items-center">
                    <div class="h-10 w-10 rounded-full bg-primary-100 flex items-center justify-center mr-3">
                        <i class="fas fa-clipboard-list text-primary-600"></i>
                    </div>
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-800 flex items-center">
                        Formulario de Registro
                        <span class="ml-2 text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">
                            <i class="fas fa-robot mr-1"></i>Con IA
                        </span>
                    </h2>
                </div>
                {% include 'mascota_registro/form.html' %}
            </div>
        </div>
        
        <!-- Pestaña 3: Datos biométricos -->
        <div id="datos-biometricos" class="tab-content" style="display: none;">
            <div class="p-4 sm:p-6 bg-white border border-primary-100 rounded-lg shadow-sm" id="datos-biometricos-content">
                <div class="mb-4 flex flex-wrap items-center">
                    <div class="h-10 w-10 rounded-full bg-primary-100 flex items-center justify-center mr-3">
                        <i class="fas fa-fingerprint text-primary-600"></i>
                    </div>
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-800">Captura de Datos Biométricos</h2>
                </div>
                
                {% if todas_mascotas_entrenadas %}
                <!-- Mensaje cuando todas las mascotas ya tienen biometría -->
                <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded-md mb-6">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-check-circle text-green-500 text-xl"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-green-800 font-medium text-lg">¡Perfecto! Todas tus mascotas tienen Reconocimiento activado</h3>
                            <p class="text-green-700 mt-2">
                                Tienes <strong>{{ mascotas_con_biometria }}</strong> mascota{{ mascotas_con_biometria|pluralize }} con reconocimiento facial activo.
                            </p>
                            <div class="mt-3 flex flex-wrap gap-2">
                                <a href="{% url 'mascota:scanner' %}" class="inline-flex items-center px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 transition-colors">
                                    <i class="fas fa-camera mr-2"></i>
                                    Usar scanner
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <!-- Contenedor para el selector de mascotas (se rellena vía JS) -->
                <div id="biometria-selector-container" class="mb-6"></div>

                <!-- Contenedor para el contenido biométrico -->
                <div id="biometria-content-container">
                    {% include 'biometria_registro/biometria.html' %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Tarjeta informativa -->
<div class="mt-6 bg-white p-4 sm:p-5 rounded-lg shadow border-l-4 border-secondary-500">
    <div class="flex flex-col sm:flex-row sm:items-center">
        <div class="flex-shrink-0 mr-0 sm:mr-3 mb-3 sm:mb-0 flex justify-center">
            <i class="fas fa-info-circle text-2xl text-secondary-500"></i>
        </div>
        <div>
            <p class="text-sm text-center sm:text-left text-gray-600">
                Complete la información de su mascota para garantizar una atención veterinaria personalizada y de calidad. La información biométrica nos ayuda a identificar a su mascota en caso de extravío.
            </p>
        </div>
    </div>
</div>

<!-- Modal para editar mascota -->
<div id="editarMascotaModal" class="fixed inset-0 bg-black bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden backdrop-blur-sm">
    <div class="relative top-4 mx-auto p-0 border-0 w-11/12 md:w-4/5 lg:w-3/5 xl:w-1/2 max-w-4xl shadow-2xl rounded-xl bg-white">
        <!-- Header del modal con gradiente -->
        <div class="bg-gradient-to-r from-primary-600 to-primary-700 rounded-t-xl px-6 py-4">
            <div class="flex items-center justify-between">
                <h3 class="text-xl font-bold text-white flex items-center">
                    <div class="bg-white bg-opacity-20 rounded-full p-2 mr-3">
                        <i class="fas fa-edit text-white"></i>
                    </div>
                    Editar Información de <span id="edit-mascota-name" class="font-extrabold ml-2"></span>
                </h3>
                <button onclick="cerrarModalEditar()" class="text-white hover:text-gray-200 transition-colors duration-200 p-2 hover:bg-white hover:bg-opacity-20 rounded-full">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
            
        <!-- Contenido del modal -->
        <div class="px-6 py-6 max-h-[80vh] overflow-y-auto">
            <form id="editarMascotaForm" enctype="multipart/form-data">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Nombre -->
                    <div class="md:col-span-2">
                        <label for="edit_nombre" class=" text-sm font-semibold text-gray-700 mb-2 flex items-center">
                            <i class="fas fa-paw text-primary-500 mr-2"></i>
                            Nombre <span class="text-red-500 ml-1">*</span>
                        </label>
                        <input type="text" id="edit_nombre" name="nombre" required 
                               class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200 hover:border-gray-300">
                    </div>
                        
                    <!-- Raza -->
                    <div>
                        <label for="edit_raza" class=" text-sm font-semibold text-gray-700 mb-2 flex items-center">
                            <i class="fas fa-dog text-orange-500 mr-2"></i>
                            Raza
                        </label>
                        <input type="text" id="edit_raza" name="raza" 
                               class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200 hover:border-gray-300">
                    </div>
                        
                    <!-- Sexo -->
                    <div>
                        <label for="edit_sexo" class="text-sm font-semibold text-gray-700 mb-2 flex items-center">
                            <i class="fas fa-venus-mars text-purple-500 mr-2"></i>
                            Sexo
                        </label>
                        <select id="edit_sexo" name="sexo" 
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200 hover:border-gray-300 bg-white">
                            <option value="">Seleccionar...</option>
                            <option value="macho">Macho</option>
                            <option value="hembra">Hembra</option>
                        </select>
                    </div>
                        
                    <!-- Edad -->
                    <div>
                        <label for="edit_edad" class=" text-sm font-semibold text-gray-700 mb-2 flex items-center">
                            <i class="fas fa-birthday-cake text-pink-500 mr-2"></i>
                            Edad
                        </label>
                        <input type="number" id="edit_edad" name="edad" min="0" 
                               class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200 hover:border-gray-300">
                    </div>
                    
                    <!-- Unidad de edad -->
                    <div>
                        <label for="edit_edad_unidad" class=" text-sm font-semibold text-gray-700 mb-2 flex items-center">
                            <i class="fas fa-clock text-blue-500 mr-2"></i>
                            Unidad
                        </label>
                        <select id="edit_edad_unidad" name="edad_unidad" 
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200 hover:border-gray-300 bg-white">
                            <option value="años">Años</option>
                            <option value="meses">Meses</option>
                        </select>
                    </div>
                    
                    <!-- Peso -->
                    <div>
                        <label for="edit_peso" class=" text-sm font-semibold text-gray-700 mb-2 flex items-center">
                            <i class="fas fa-weight text-green-500 mr-2"></i>
                            Peso (kg)
                        </label>
                        <input type="number" step="0.1" id="edit_peso" name="peso" min="0" 
                               class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200 hover:border-gray-300">
                    </div>
                    
                    <!-- Color -->
                    <div>
                        <label for="edit_color" class=" text-sm font-semibold text-gray-700 mb-2 flex items-center">
                            <i class="fas fa-palette text-yellow-500 mr-2"></i>
                            Color
                        </label>
                        <input type="text" id="edit_color" name="color" 
                               class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200 hover:border-gray-300">
                    </div>
                        
                    <!-- Etapa de vida -->
                    <div>
                        <label for="edit_etapa_vida" class=" text-sm font-semibold text-gray-700 mb-2 flex items-center">
                            <i class="fas fa-calendar-alt text-indigo-500 mr-2"></i>
                            Etapa de Vida
                        </label>
                        <select id="edit_etapa_vida" name="etapa_vida" 
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200 hover:border-gray-300 bg-white">
                            <option value="">Seleccionar...</option>
                            <option value="cachorro">Cachorro</option>
                            <option value="joven">Joven</option>
                            <option value="adulto">Adulto</option>
                            <option value="senior">Senior</option>
                        </select>
                    </div>
                    
                    <!-- Estado corporal -->
                    <div>
                        <label for="edit_estado_corporal" class=" text-sm font-semibold text-gray-700 mb-2 flex items-center">
                            <i class="fas fa-heartbeat text-red-500 mr-2"></i>
                            Estado Corporal
                        </label>
                        <select id="edit_estado_corporal" name="estado_corporal" 
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200 hover:border-gray-300 bg-white">
                            <option value="">Seleccionar...</option>
                            <option value="delgado">Delgado</option>
                            <option value="normal">Normal</option>
                            <option value="obeso">Obeso</option>
                        </select>
                    </div>
                    
                    <!-- Fecha de nacimiento -->
                    <div>
                        <label for="edit_fecha_nacimiento" class=" text-sm font-semibold text-gray-700 mb-2 flex items-center">
                            <i class="fas fa-calendar text-teal-500 mr-2"></i>
                            Fecha de Nacimiento
                        </label>
                        <input type="date" id="edit_fecha_nacimiento" name="fecha_nacimiento" 
                               class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200 hover:border-gray-300">
                    </div>
                        
                    <!-- Características especiales -->
                    <div class="md:col-span-2">
                        <label for="edit_caracteristicas_especiales" class=" text-sm font-semibold text-gray-700 mb-2 flex items-center">
                            <i class="fas fa-clipboard-list text-gray-600 mr-2"></i>
                            Características Especiales
                        </label>
                        <textarea id="edit_caracteristicas_especiales" name="caracteristicas_especiales" rows="4" 
                                  placeholder="Describe características especiales de la mascota..."
                                  class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200 hover:border-gray-300 resize-none"></textarea>
                    </div>
                    
                    <!-- Foto de perfil -->
                    <div class="md:col-span-2">
                        <label for="edit_foto_perfil" class=" text-sm font-semibold text-gray-700 mb-2 flex items-center">
                            <i class="fas fa-camera text-violet-500 mr-2"></i>
                            Foto de Perfil
                        </label>
                        <div class="relative">
                            <input type="file" id="edit_foto_perfil" name="foto_perfil" accept="image/*" 
                                   class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200 hover:border-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary-50 file:text-primary-700 hover:file:bg-primary-100">
                        </div>
                        <div id="current-photo-preview" class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200 hidden">
                            <p class="text-sm font-medium text-gray-700 mb-3 flex items-center">
                                <i class="fas fa-image text-gray-500 mr-2"></i>
                                Foto actual:
                            </p>
                            <img id="current-photo-img" src="" alt="Foto actual" class="h-24 w-24 object-cover rounded-lg shadow-sm border border-gray-200">
                        </div>
                    </div>
                    </div>
                </div>
                
                <!-- Botones del modal -->
                <div class="bg-gray-50 px-6 py-4 rounded-b-xl border-t border-gray-200">
                    <div class="flex justify-end space-x-4">
                        <button type="button" onclick="cerrarModalEditar()" 
                                class="px-6 py-3 text-sm font-semibold text-gray-700 bg-white border-2 border-gray-300 rounded-lg hover:bg-gray-50 hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all duration-200 flex items-center">
                            <i class="fas fa-times mr-2"></i>
                            Cancelar
                        </button>
                        <button type="submit" id="guardar-cambios-btn" 
                                class="px-6 py-3 text-sm font-semibold text-white bg-gradient-to-r from-primary-600 to-primary-700 border-2 border-transparent rounded-lg hover:from-primary-700 hover:to-primary-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105">
                            <i class="fas fa-save mr-2"></i>
                            <span id="guardar-btn-text">Guardar Cambios</span>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

</div> 
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'js/utils.js' %}"></script>
<script src="{% static 'js/app-config.js' %}"></script>
<script src="{% static 'js/mascota-tabs.js' %}"></script>
<script src="{% static 'js/qr-management.js' %}"></script>
<script src="{% static 'js/biometria-management.js' %}"></script>
<script src="{% static 'js/mascota-management.js' %}"></script>
<script src="{% static 'js/mascota-perdida.js' %}"></script>
<script src="{% static 'js/mascota.js' %}"></script>
<script src="{% static 'js/editar_mascota.js' %}"></script>
<script src="{% static 'js/biometria_captura.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    // Inicializar configuración de la aplicación
    document.addEventListener('DOMContentLoaded', function() {
        window.configUtils.init({
            activeBiometriaId: {% if active_biometria_id %}'{{ active_biometria_id }}'{% else %}null{% endif %}
        });
        
        // Validación para deshabilitar pestaña de registro si se alcanzó el límite
        {% if total_mascotas_usuario >= 2 %}
        const registroTab = document.querySelector('[data-target="registro-normal"]');
        if (registroTab) {
            registroTab.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                alert('Has alcanzado el límite máximo de 2 mascotas por usuario.');
                return false;
            });
        }
        {% endif %}
    });
</script>
{% endblock %}

{% block extra_head %}

<link rel="stylesheet" href="{% static 'css/mascota.css' %}">
<link rel="stylesheet" href="{% static 'css/editar_mascota.css' %}">


{% endblock %}